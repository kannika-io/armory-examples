#!/bin/bash
#
# Unified setup script for Kannika Armory tutorials
#
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TUTORIALS_DIR="${SCRIPT_DIR}/tutorials"

source "${SCRIPT_DIR}/scripts/env.sh"
source "${SCRIPT_DIR}/scripts/print-help.sh"
__env_load

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

usage() {
    cat << EOF
Usage: ./setup <command> [options]

Run a Kannika Armory tutorial or set up individual components.

COMMANDS:
    <tutorial>    Run the specified tutorial (sets up everything)
    armory        Set up Kannika Armory only (Kind cluster + Helm)
    kafka         Set up Kafka clusters only (docker-compose + network)
    tools         Install kind, kubectl, and helm to .bin directory
    list          List available tutorials

OPTIONS:
    -h, --help    Show this help message

AVAILABLE TUTORIALS:
EOF
    list_tutorials "    "
    echo ""
    echo "EXAMPLES:"
    echo "    ./setup migrate-consumer-groups"
    echo "    ./setup armory"
    echo "    ./setup kafka"
    echo "    ./setup tools"
    echo "    ./setup list"
    echo ""
}

list_tutorials() {
    local prefix="${1:-}"
    for dir in "${TUTORIALS_DIR}"/*/; do
        [ -d "$dir" ] || continue
        local name=$(basename "$dir")
        local init_file="${dir}init.sh"
        if [ -f "$init_file" ]; then
            local desc=""
            if [ -f "${dir}README.md" ]; then
                desc=$(head -1 "${dir}README.md" | sed 's/^#* *//')
            fi
            if [ -n "$desc" ]; then
                printf "%s%-25s %s\n" "$prefix" "$name" "$desc"
            else
                echo "${prefix}${name}"
            fi
        fi
    done
}

setup_tools() {
    print_info "Installing tools to .bin directory..."
    "${SCRIPT_DIR}/scripts/install-kind.sh"
    "${SCRIPT_DIR}/scripts/install-kubectl.sh"
    "${SCRIPT_DIR}/scripts/install-helm.sh"
    print_info "Tools installed. Reloading PATH..."
    __env_setup_path
    print_info "Done. Tools available at: ${SCRIPT_DIR}/.bin"
}

setup_armory() {
    if kind get clusters 2>/dev/null | grep -q "^kannika-kind$"; then
        print_warning "Kannika Kind cluster already exists, skipping armory setup."
        return 0
    fi
    print_info "Setting up Kannika Armory..."
    "${SCRIPT_DIR}/scripts/setup-kannika-armory.sh" "$@"
}

setup_kafka() {
    print_info "Starting Kafka clusters..."
    docker-compose -f "${SCRIPT_DIR}/docker-compose.yml" up -d

    print_info "Waiting for Kafka to be ready..."
    sleep 10
}

setup_network() {
    print_info "Connecting Kind to Kafka network..."
    "${SCRIPT_DIR}/scripts/connect-kafka-to-kind.sh"
}

run_tutorial_init() {
    local tutorial="$1"
    local tutorial_dir="${TUTORIALS_DIR}/${tutorial}"
    local init_file="${tutorial_dir}/init.sh"

    if [ ! -f "$init_file" ]; then
        print_warning "No init.sh found for tutorial ${tutorial}, skipping tutorial init"
        return 0
    fi

    if [ ! -x "$init_file" ]; then
        chmod +x "$init_file"
    fi

    print_info "Initializing tutorial resources..."
    "$init_file"
}

print_help() {
    local tutorial="$1"
    local tutorial_dir="${TUTORIALS_DIR}/${tutorial}"

    # Read credentials from secret
    ARMORY_USERNAME=$(kubectl get secret api -n kannika-system -o jsonpath='{.data.username}' 2>/dev/null | base64 -d)
    ARMORY_PASSWORD=$(kubectl get secret api -n kannika-system -o jsonpath='{.data.password}' 2>/dev/null | base64 -d)

    echo ""
    echo "=============================================="
    echo "Setup Complete!"
    echo "=============================================="
    echo ""
    print_armory_info
    echo ""
    print_kafka_info
    echo ""

    # Print tutorial-specific help if exists
    if [ -f "${tutorial_dir}/help.txt" ]; then
        echo "----------------------------------------------"
        echo ""
        cat "${tutorial_dir}/help.txt"
    fi

    echo ""
    print_teardown_info
    echo ""
}

run_tutorial() {
    local tutorial="$1"
    shift
    local tutorial_dir="${TUTORIALS_DIR}/${tutorial}"

    if [ ! -d "$tutorial_dir" ]; then
        print_error "Tutorial not found: ${tutorial}"
        echo ""
        echo "Available tutorials:"
        list_tutorials "  "
        exit 1
    fi

    if [ ! -f "${tutorial_dir}/init.sh" ]; then
        print_error "No init.sh found in ${tutorial_dir}"
        exit 1
    fi

    echo "=============================================="
    echo "Setup: ${tutorial}"
    echo "=============================================="
    echo ""

    setup_armory "$@"
    setup_kafka
    setup_network
    run_tutorial_init "$tutorial"
    print_help "$tutorial"
}

main() {
    if [ $# -eq 0 ]; then
        usage
        exit 1
    fi

    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        list)
            echo "Available tutorials:"
            echo ""
            list_tutorials "  "
            echo ""
            ;;
        armory)
            shift
            if kind get clusters 2>/dev/null | grep -q "^kannika-kind$"; then
                print_warning "Kannika Kind cluster already exists."
                read -p "Re-run armory setup anyway? [y/N] " -n 1 -r
                echo ""
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    exit 0
                fi
                # User confirmed, run directly bypassing skip check
                "${SCRIPT_DIR}/scripts/setup-kannika-armory.sh" "$@"
            else
                setup_armory "$@"
            fi
            ;;
        kafka)
            setup_kafka
            # Check if Kind cluster is running and offer to connect
            if docker ps --format '{{.Names}}' | grep -q "kannika-kind-control-plane"; then
                echo ""
                read -p "Kind cluster detected. Connect Kafka to Kind network? [Y/n] " -n 1 -r
                echo ""
                if [[ ! $REPLY =~ ^[Nn]$ ]]; then
                    setup_network
                fi
            fi
            ;;
        tools)
            setup_tools
            ;;
        *)
            run_tutorial "$@"
            ;;
    esac
}

main "$@"
